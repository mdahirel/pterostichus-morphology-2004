---
title: 'Supplementary Material for: "Shifts in colour morph frequencies along an urbanisation gradient in the ground beetle *Pterostichus madidus*"'
author: "Maxime Dahirel, Hélène Audusseau, Solène Croci"
date:
output: pdf_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```


```{r packages}
library(tidyverse)
library(sf)
library(lubridate)
library(brms)
library(cmdstanr)
library(tidybayes)

library(here)

options(mc.cores = 4) 
```

# S1 - Model description

For the present study, our response variable is $n_{i,j}/N_{i,j}$, the proportion of black-legged *P. madidus* beetles captured in a given woodland $i$ during a given sampling session $j$, with $N_{i,j}$ the corresponding total number of *P. madidus* beetles. Note that this  naturally only includes woodland $\times$ session combinations with $N_{i,j} > 0$. We ran the below models for each of the 8 possible urbanisation metrics described in the main text.

We initially built binomial models as follows:

$$
n_{i,j} \sim \mathrm{Binomial}(p_{i,j}, N_{i,j}),
$$
$$
\mathrm{logit}(p_{i,j}) = \beta_{0}  + (\beta_{1} + \eta_{j}) \times x_{i} + \alpha_{i} + \gamma_{j},
$$
with $x_{i}$ the (centered and scaled) urbanisation metric at site $i$, $\beta_0$ and $\beta_1$ the fixed-effects intercept and urbanisation slope, respectively, $\alpha_{i}$ the site-specific random intercept, and $\gamma_{j}$ and $\eta_{j}$ the session-specific random intercept and slope. Random effects are distributed as follows: 

$$
\alpha_{i} \sim \mathrm{Normal}(0, \sigma_{\alpha}),
$$
$$
\begin{bmatrix} \gamma_{j} \\ \eta_{j} \end{bmatrix} 
\sim 
\textrm{MVNormal}
\begin{pmatrix}
\begin{bmatrix} 0 \\ 0  \end{bmatrix},
\boldsymbol{\Omega}
\end{pmatrix},
$$
, where $\boldsymbol{\Omega}$ is the covariance matrix for the session-specific random effects, which can be decomposed into its constituent standard deviations and correlation matrix $\boldsymbol{R}$ in this way:

$$
\boldsymbol{\Omega} = 
\begin{bmatrix}
\sigma_{\gamma} & 0 \\
0 & \sigma_{\eta}
\end{bmatrix}
\boldsymbol{R}
\begin{bmatrix}
\sigma_{\gamma} & 0 \\
0 & \sigma_{\eta}
\end{bmatrix}.
$$
We used weakly informative priors mostly inspired by @mcelreathStatisticalRethinkingBayesian2020. We used $\mathrm{Normal}(0,1)$ priors for the fixed effects $\beta$,<!--DIFFERENT PRIORS FOR BETA0 AND BETA1 YES? CHECK AND IF YES WILL AFFECT HOW THE MODEL DESCRIPTION FOR TH NEGBINOMIAL BELOW IS WRITTEN--> and $\mathrm{Half-Normal}(0,1)$ priors for all standard deviations $\sigma$. We used a $\mathrm{LKJ}(2)$ prior for the correlation matrix $\boldsymbol{R}$.


Evaluations of these models revealed slight but consistent evidence of overdispersion. We therefore fitted the equivalent beta-binomial models to account for that overdispersion <!--ref-->:

$$
n_{i,j} \sim \mathrm{BetaBinomial}(p_{i,j}, N_{i,j}, \phi),
$$
where $\phi$ is an added overdispersion parameter with prior $1/\phi \sim \mathrm{HalfNormal}(0,1)$. The remainder of the models is the same as in the binomial case. 

# S2 - Model performance comparisons

We used two metrics to compare our beta-binomial models. We first used $K$-fold cross-validation ($K$ = 10) to evaluate these models based on their overall predictive performance [@vehtariPracticalBayesianModel2017]. We then also compared them based on the proportion of (logit-scale) among-site variance explained by fixed effects $\frac{\sigma_{\beta}^2}{\sigma_{\beta}^2 + \sigma_{\alpha}^2}$, where the variance explained by fixed effects $\sigma_{\beta}^2$ is estimated as in <!--ref-->. This is because since all models include a site random effect, comparing them on their overall performance may not reflect the way urbanisation specifically explains average among-site differences, as the site random effect will "absorb" any among-site variation not explained by the urbanisation metric. 

All eight models had very similar overall predictive performance based on cross-validation results (**Table S2-1**). The proportion of among-site variance explained by the effect of urbanisation was highest at the 100 m scale and decreased as buffer size increased, with the lowest value for the fixed effect of distance to the urban centroid (**Fig. S2-1**). However, pairwise comparisons showed limited support for differences between models, with credible intervals all overlapping 0 (**Fig. S2-1** <!--S2-2??-->). 


# S3 - Model effect of urbanisation comparison

The standardised effect of urbanisation $\beta_{1}$ is quite consistent whether distance to city centroid or local Imperviousness Density is used as urbanisation metric, and regardless of the spatial scale at which imperviousness Density is estimated (**Fig. S3-1**).


**Figure S3-1.** <!--LEGEND TO COMPLETE--> Note that the sign of the posterior values for distance to city centroid is inversed to make the comparison with the other posteriors easier (as distances to city centroid decrease when urbanisation increases).


# S4 - Seasonal variation in urbanisation effect



# S5 - Population size variability along the urbanisation gradient

# References