---
title: 'analysis of Pterostichus madidus morphology on 2004-2005 ground beetle data'
author: ""
date:
output:
  html_document:
    theme: yeti
    toc: TRUE
    toc_float: TRUE
    code_download: TRUE
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages}
library(tidyverse)
library(lubridate)
library(brms)
library(cmdstanr)
library(tidybayes)

library(here)

options(mc.cores = 4) 
```

# Introduction

<!--SOME CONTEXT TO ADD -->
As far as I can tell, nobody really used *Pterostichus madidus* polymorphism as an evolutionary ecology model in cities (not a lot of people used it as an evolutionary model *at all* actually, even outside cities).
There's a few urban data in that 2002 thesis, but a bit messy; there is also an actual *P. madidus* urban evolutionary study (carabids more generally actually; the refs are in the urban evolution book), but it was based on genetic diversity, not phenotypic polymorphism, so we're safe.

# Data loading and preparation

First we load all the data (note that *P. madidus* data come in two separate files, one for the red-legged morph, one for the black-legged).

```{r data}
raw_blackleg <-read_csv(here("data","pterostichus_madidus_blackleg_2004_2005.csv"))
raw_redleg <-read_csv(here("data","pterostichus_madidus_redleg_2004_2005.csv"))
sites <-read_csv(here("data","sites_2004_2005.csv"))
dates <- read_csv(here("data","sampling_dates_2004_2005.csv"))
```

<!--describe data content-->

Now we reshape the data so they are in the long format, we remove the `RB12` site which was more or less abandoned because boars (see Solène's paper), and we add and reorder some variables so that things are easier down the line

```{r}
blackleg <- raw_blackleg %>% 
  pivot_longer(cols=-CAMP,names_to = "SITE",values_to = "N_blackleg") 

redleg <- raw_redleg %>% 
  pivot_longer(cols=-CAMP,names_to = "SITE",values_to = "N_redleg")

data <- left_join(blackleg,redleg) %>% 
  mutate(N_total=N_redleg+N_blackleg) %>% 
  filter(N_total>0) %>% #we remove all dates where no madidus at all were found
  left_join(sites) %>% 
  left_join(dates) %>% 
  mutate(SPECIES="Pterostichus madidus",
         doy=yday(dmy(DATE)),
         YEAR=factor(YEAR)) %>% 
  filter(SITE!="RB12") %>%  ## that site should be removed because trampled by boars (see Solène paper)
  mutate(TYPE=fct_relevel(TYPE,"city_center","suburban","periurban")) #re-ordering
```

We note a few numbers useful for the Material and Methods:
```{r}
sum(blackleg$N_blackleg)+sum(redleg$N_redleg) # total beetles in the source datasets (so including RB12)

sum(data$N_total) # total beetles in the final dataset (so excluding RB12)

length(unique(data$CAMP)) # number of sites in the final dataset
```

We can do a rough visualisation
```{r}
data %>% 
  ggplot()+
  geom_point(aes(doy,N_blackleg/N_total,
                 size=N_total,col=YEAR))+  
  facet_wrap(~TYPE)
```

mm, looks like there is clearly an effect of urbanisation
# Models


```{r}
mod <- brm(N_blackleg|trials(N_total)~TYPE+
                                      (1|SITE)+         # among site variation not explained by fixed effects (to convert to GP later???)
                                      (TYPE|CAMP),      # among sampling campaign variation
        family=binomial,
        data=data,
        backend="cmdstanr",
        seed=42,
        prior=c(
          set_prior("normal(0,1)",class="b"),
          set_prior("normal(0,1)",class="Intercept"),
          set_prior("normal(0,1)",class="sd")
        )
        )
```


```{r}
summary(mod)
```

# Figures

```{r}

newdata=data %>% 
  select(TYPE) %>% 
  distinct() %>% 
  mutate(N_total=1) %>% 
  add_epred_draws(mod,re_formula=NA)

data %>% 
  ggplot()+
  geom_jitter(aes(TYPE,N_blackleg/N_total,
                 size=N_total),col="grey")+
  stat_eye(data=newdata,aes(x=TYPE,y=.epred),.width=c(0.001,0.95),slab_alpha=0.3,point_size=3,fill="green")+
  scale_x_discrete("urbanisation level")+
  scale_y_continuous("proportion of black-legged individuals")+
  theme_bw()

data %>% 
  ggplot()+
  geom_boxplot(aes(TYPE,N_blackleg/N_total,
                  group=SITE),col="grey")+
  stat_eye(data=newdata,aes(x=TYPE,y=.epred),.width=c(0.001,0.95),slab_alpha=0.3,point_size=3,fill="green")+
  scale_x_discrete("urbanisation level")+
  scale_y_continuous("proportion of black-legged individuals")+
  theme_bw()
```
